<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kehadiran Siswa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; margin:0 }
header { background:#1e88e5; color:white; padding:20px; text-align:center }
.container { padding:20px }
input, select, button {
  width:100%; padding:10px; margin-top:10px;
  border-radius:6px; border:1px solid #ccc
}
button { background:#1e88e5; color:white; border:none }
.card {
  background:white; padding:15px; margin-top:15px; border-radius:8px
}
.rekap {
  margin-top:10px;
  font-weight:bold;
  line-height:1.6
}
</style>
</head>

<body>

<header>
<h2>üìÖ Kehadiran Siswa</h2>
<a href="index.html" style="color:white">‚Üê Kembali</a>
</header>

<div class="container">
  <input id="kode" placeholder="Masukkan Kode Orang Tua">
  <button onclick="cek()">Lihat Kehadiran</button>

  <select id="filterBulan" onchange="tampil()" style="display:none"></select>

  <div id="hasil"></div>
</div>

<script>
let semuaData = [];

function parseTanggal(tgl) {
  // Cek format yyyy-mm-dd
  if (tgl.includes('-')) {
    return new Date(tgl);
  }
  
  // Format m/d/yyyy
  const p = tgl.split("/");
  let m = p[0].padStart(2, "0");
  let d = p[1].padStart(2, "0");
  let y = p[2].length === 2 ? "20" + p[2] : p[2];
  return new Date(`${y}-${m}-${d}`);
}

async function cek() {
  const kode = document.getElementById("kode").value.trim();
  const res = await fetch("kehadiran.csv");
  const text = await res.text();

  semuaData = [];
  const rows = text.split("\n").slice(1);

  rows.forEach(r => {
    if (!r.trim()) return;

    const col = r.split(";").map(x => x.trim());
    if (col.length < 4) return;

    const [k, nama, tanggal, statusRaw] = col;

    if (k === kode) {
      const dateObj = parseTanggal(tanggal);
      semuaData.push({
        nama,
        tanggal,
        status: statusRaw.toUpperCase(),
        dateObj,
        bulan: `${dateObj.getMonth()+1}-${dateObj.getFullYear()}`
      });
    }
  });

  if (semuaData.length === 0) {
    document.getElementById("hasil").innerHTML =
      "<p>Data tidak ditemukan</p>";
    document.getElementById("filterBulan").style.display = "none";
    return;
  }

  // URUT TERBARU
  semuaData.sort((a,b) => b.dateObj - a.dateObj);

  // DROPDOWN BULAN
  const select = document.getElementById("filterBulan");
  select.innerHTML = `<option value="all">Semua Bulan</option>`;

  [...new Set(semuaData.map(d => d.bulan))].forEach(b => {
    const [m,y] = b.split("-");
    select.innerHTML += `<option value="${b}">${m}/${y}</option>`;
  });

  select.style.display = "block";
  tampil();
}

function tampil() {
  const pilih = document.getElementById("filterBulan").value;
  const hasil = document.getElementById("hasil");
  hasil.innerHTML = "";

  const data = pilih === "all"
    ? semuaData
    : semuaData.filter(d => d.bulan === pilih);

  let hadir=0, terlambat=0, alpha=0, sakit=0, ijin=0;

  data.forEach(d => {
    switch (d.status) {
      case "HADIR": hadir++; break;
      case "TERLAMBAT": terlambat++; break;
      case "SAKIT": sakit++; break;
      case "IJIN": ijin++; break;
      default: alpha++;
    }
  });

  hasil.innerHTML += `
    <div class="card">
      <b>${data[0].nama}</b>
      <div class="rekap">
        ‚úî HADIR: ${hadir}<br>
        ‚è∞ TERLAMBAT: ${terlambat}<br>
        ü§í SAKIT: ${sakit}<br>
        üìù IJIN: ${ijin}<br>
        ‚ùå ALPHA: ${alpha}
      </div>
    </div>
  `;

  data.forEach(d => {
    hasil.innerHTML += `
      <div class="card">
        ${d.tanggal} ‚Äî <b>${d.status}</b>
      </div>
    `;
  });
}
</script>

</body>
</html>
